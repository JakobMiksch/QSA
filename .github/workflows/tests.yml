name: Tests

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  run_tests:
    runs-on: ubuntu-latest
    container:
      image: postgis/postgis:15-3.4
    services:
        postgres:
          image: postgres
          env:
            POSTGRES_DB: my_database
            POSTGRES_PASSWORD: postgres
            POSTGRES_USER: postgres
          # Set health checks to wait until postgres has started
          options: >-
            --health-cmd pg_isready
            --health-interval 10s
            --health-timeout 5s
            --health-retries 5
          ports:
            - 5432:5432
  
    steps:
      - uses: actions/checkout@v4
      - name: install system dependencies 
        run: apt update && apt install -y python3-poetry python3-flask python3-boto3
      - name: Install Python dependencies
        working-directory: qsa-api
        run: poetry install
      - name: Run test without Postgres Dependency
        working-directory: qsa-api
        run: pytest -sv tests/test_api_storage_postgresql.py
